<?php
/*
* Function that search TVDB for a show and returns the data
*/
function tvdb_search($search_term) {
    $token = variable_get('tvdb_search_token', '');
    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $url = "https://api.thetvdb.com/search/series?name=" . urlencode($search_term);

    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");


    $headers = array();
    $headers[] = "Accept: application/json";
    $headers[] = "Authorization: Bearer $token";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        $error = curl_error($ch);
        curl_close ($ch);
        return 'Error:' . $error;
    } else {
        curl_close ($ch);
        $result_object = json_decode($result);
        return $result_object;
    }
}

function tvdb_get_episodes_by_show_id($show_id) {
    $token = variable_get('tvdb_search_token', '');
    $url = "https://api.thetvdb.com/series/$show_id/episodes";
    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");


    $headers = array();
    $headers[] = "Accept: application/json";
    $headers[] = "Authorization: Bearer $token";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        return 'Error:' . curl_error($ch);
        curl_close ($ch);
    } else {
        curl_close($ch);
        return json_decode($result);
    }
}

function tvdb_search_login() {
    $apikey = variable_get('tvdb_search_apikey', '');
    $username = variable_get('tvdb_search_username', '');
    $userkey = variable_get('tvdb_search_userkey', '');

    $postfields = "{\"apikey\": \"$apikey\",\"username\": \"$username\",  \"userkey\": \"$userkey\"\n}";

    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, "https://api.thetvdb.com/login");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, "{\"apikey\": \"$apikey\",\"username\": \"$username\",  \"userkey\": \"$userkey\"\n}");
    curl_setopt($ch, CURLOPT_POST, 1);

    $headers = array();
    $headers[] = "Content-Type: application/json";
    $headers[] = "Accept: application/json";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        echo 'Error:' . curl_error($ch);
    }
    curl_close ($ch);
    $token_object = json_decode($result);
    variable_set('tvdb_search_token', $token_object->token);
    echo "<pre>";
    var_dump($token_object->token);
    echo "</pre>";
    exit;
}

function tvdb_search_refresh_token() {
    $token = variable_get('tvdb_search_token', '');
    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, "https://api.thetvdb.com/refresh_token");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");


    $headers = array();
    $headers[] = "Accept: application/json";
    $headers[] = "Authorization: Bearer $token";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        echo 'Error:' . curl_error($ch);
    }
    curl_close ($ch);
    $result_object = json_decode($result);
    $new_token = $result_object->token;
    variable_set('tvdb_search_token', $new_token);
}
