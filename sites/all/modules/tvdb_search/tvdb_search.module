<?php
/*
* Implements hook_permission()
*/
function tvdb_search_permission() {
    $permissions['administer tvdb search'] = array(
            'title' => t('Administer TVDB Search'),
            'description' => t('Perform administration tasks for TVDB Search module.'),
        );
    return $permissions;
}

/*
* Implements hook_menu()
*/
function tvdb_search_menu() {
    $items = array();
    $items['admin/config/tvdb_search'] = array(
            'title' => 'TVDB Search Settings',
            'type' => MENU_NORMAL_ITEM,
            'page callback' => 'drupal_get_form',
            'page arguments' => array('tvdb_search_config_form'),
            'access arguments' => array('administer tvdb search'),
        );
    $items['tvdb_search'] = array(
            'title' => 'TVDB Search',
            'type' => MENU_NORMAL_ITEM,
            'access callback' => TRUE,
            'page callback' => 'drupal_get_form',
            'page arguments' => array('tvdb_search_form'),
            'menu_name' => 'main-menu',
        );
    $items['tvdb_login'] = array(
            'title' => 'TVDB Login',
            'type' => MENU_NORMAL_ITEM,
            'access callback' => TRUE,
            'page callback' => 'tvdb_login',
            'menu_name' => 'main-menu',
        );
    $items['tvdb_search/%/results'] = array(
            'title' => 'TVDB Search Results',
            'type' => MENU_CALLBACK,
            'access callback' => TRUE,
            'page callback' => 'tvdb_search_results_display_page',
            'page arguments' => array(1),
        );
    return $items;
}

/*
* TVDB Search form
*/
function tvdb_search_form($form, &$form_state) {
    $form['tvdb_search_search_term'] = array(
            '#type' => 'textfield',
            '#title' => t('Search TVDB'),
            '#description' => t('Enter the title of a TV series to search for.'),
        );
    $form['tvdb_search_submit'] = array(
            '#type' => 'submit',
            '#value' => t('Search'),
        );
    return $form;
}

function tvdb_search_results_display_page($search_term) {
    $href = variable_get('tvdb_search_link_href', '');
    $link_text = variable_get('tvdb_search_link_text', '');
    $results = tvdb_search($search_term);
    $link = '';
    if ($href && $link_text) {
    }
    dpm($results);
    $search_form = drupal_get_form('tvdb_search_form');
    $string = '';
    $string .= drupal_render($search_form);
    $string .= '<h2>Results of search for "' . $search_term . '":</h2>';
    foreach($results->data as $show) {
        $string .= "<h3>Show Title: " . $show->seriesName . "</h3>";
        $string .= "<p>Overview: " . $show->overview . "</p>";
        $string .= "<p>Network: " . $show->network . "</p>";
        $string .= "<p>Status: " . $show->status . "</p>";
        $link = l($link_text, $href . '/' . $show->id . '/' . $show->seriesName, array(
            'html' => TRUE,
        ));
        $string .= $link;
        $string .= "<hr>";
    }
    return $string;
}

/*
*
*/
function tvdb_search_form_submit($form, &$form_state) {
    $search_term = $form_state['values']['tvdb_search_search_term'];
    $form_state['redirect'] = 'tvdb_search/' . $search_term . '/results';
}

/*
* Administration form
*/
function tvdb_search_config_form($form, &$form_state) {
    $form['tvdb_search_apikey'] = array(
            '#type' => 'textfield',
            '#title' => t('TVDB Api Key'),
            '#default_value' => variable_get('tvdb_search_apikey', ''),
        );
    $form['tvdb_search_username'] = array(
            '#type' => 'textfield',
            '#title' => t('TVDB Username'),
            '#default_value' => variable_get('tvdb_search_username', ''),
        );
    $form['tvdb_search_userkey'] = array(
            '#type' => 'textfield',
            '#title' => t('TVDB Userkey'),
            '#default_value' => variable_get('tvdb_search_userkey', ''),
        );
    $form['tvdb_search_token'] = array(
            '#type' => 'textfield',
            '#title' => t('TVDB Token'),
            '#default_value' => variable_get('tvdb_search_token', ''),
            '#disabled' => TRUE,
        );
    $form['tvdb_search_link_text'] = array(
            '#type' => 'textfield',
            '#title' => t('Link Text'),
            '#description' => t('This will be the link text of the link that is attached to each found show.'),
            '#default_value' => variable_get('tvdb_search_link_text', ''),
        );
    $form['tvdb_search_link_href'] = array(
            '#type' => 'textfield',
            '#title' => t('Link HREF'),
            '#description' => t('This is the path that the link will lead to.'),
            '#default_value' => variable_get('tvdb_search_link_href', ''),
        );
    return system_settings_form($form);
}

/*
* Function that search TVDB for a show and returns the data
*/
function tvdb_search($search_term) {
    $token = variable_get('tvdb_search_token', '');
    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $url = "https://api.thetvdb.com/search/series?name=" . urlencode($search_term);

    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");


    $headers = array();
    $headers[] = "Accept: application/json";
    $headers[] = "Authorization: Bearer $token";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        $error = curl_error($ch);
        curl_close ($ch);
        return 'Error:' . $error;
    } else {
        curl_close ($ch);
        $result_object = json_decode($result);
        return $result_object;
    }
}

function tvdb_get_episodes_by_show_id($show_id) {
    $token = variable_get('tvdb_search_token', '');
    $url = "https://api.thetvdb.com/series/$show_id/episodes";
    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");


    $headers = array();
    $headers[] = "Accept: application/json";
    $headers[] = "Authorization: Bearer $token";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        return 'Error:' . curl_error($ch);
        curl_close ($ch);
    } else {
        curl_close($ch);
        return json_decode($result);
    }
}

function tvdb_login() {
    $apikey = variable_get('tvdb_search_apikey', '');
    $username = variable_get('tvdb_search_username', '');
    $userkey = variable_get('tvdb_search_userkey', '');

    $postfields = "{\"apikey\": \"$apikey\",\"username\": \"$username\",  \"userkey\": \"$userkey\"\n}";

    // Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
    $ch = curl_init();

    curl_setopt($ch, CURLOPT_URL, "https://api.thetvdb.com/login");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, "{\"apikey\": \"$apikey\",\"username\": \"$username\",  \"userkey\": \"$userkey\"\n}");
    curl_setopt($ch, CURLOPT_POST, 1);

    $headers = array();
    $headers[] = "Content-Type: application/json";
    $headers[] = "Accept: application/json";
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

    $result = curl_exec($ch);
    if (curl_errno($ch)) {
        echo 'Error:' . curl_error($ch);
    }
    curl_close ($ch);
    $token_object = json_decode($result);
    variable_set('tvdb_search_token', $token_object->token);
    echo "<pre>";
    var_dump($token_object->token);
    echo "</pre>";
    exit;
}
